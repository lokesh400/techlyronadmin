<!DOCTYPE html>
<html>
<head>
  <title><%= formTitle %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <%- include('../partials/sidebar') %>
  <div class="content">
    <%- include('../partials/header', { admin: admin }) %>
    <div class="container-fluid mt-4">
      <h3><%= formTitle %></h3>
      <% if (errors && errors.length > 0) { %>
        <% errors.forEach(function(err){ %>
          <div class="alert alert-danger"><%= err.msg %></div>
        <% }) %>
      <% } %>
      <form action="<%= action %>" method="POST" id="projectForm">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Project Name</label>
            <input type="text" name="projectName" class="form-control" value="<%= project ? project.projectName || project.projectName : '' %>" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Client Name</label>
            <input type="text" name="clientName" class="form-control" value="<%= project ? project.clientName || project.clientName : '' %>" required>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Mobile</label>
            <input type="text" name="mobile" class="form-control" value="<%= project ? project.mobile || project.mobile : '' %>" required>
          </div>
          <div class="col-md-8 mb-3">
            <label class="form-label">Business Name</label>
            <input type="text" name="businessName" class="form-control" value="<%= project ? project.businessName || project.businessName : '' %>">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Services</label>
          <div class="input-group mb-2">
            <input type="text" class="form-control" id="serviceInput" placeholder="Add a service">
            <button type="button" class="btn btn-outline-primary" id="addServiceBtn">Add</button>
          </div>
          <div id="serviceList" class="border rounded p-2"></div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Total Amount</label>
            <input type="number" name="totalAmount" class="form-control" value="<%= project ? project.totalAmount || project.totalAmount : '' %>" required>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Project Created Date</label>
            <input type="date" name="projectCreatedDate" class="form-control" value="<%= project && project.projectCreatedDate ? new Date(project.projectCreatedDate).toISOString().slice(0,10) : '' %>">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Live Date</label>
            <input type="date" name="liveDate" class="form-control" id="liveDate" value="<%= project && project.liveDate ? new Date(project.liveDate).toISOString().slice(0,10) : '' %>">
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Due Date (1 year)</label>
            <input type="date" class="form-control" id="dueDate" readonly>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Total Paid</label>
            <input type="number" class="form-control" id="totalPaidDisplay" readonly>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Payments</label>
          <div class="table-responsive">
            <table class="table" id="paymentsTable">
              <thead>
                <tr>
                  <th>Amount</th>
                  <th>Mode</th>
                  <th>Paid On</th>
                  <th>Note</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><input type="number" name="paymentAmount" class="form-control payment-amount" step="0.01"></td>
                  <td>
                    <select name="paymentMode" class="form-select">
                      <option value="UPI">UPI</option>
                      <option value="Cash">Cash</option>
                      <option value="Bank">Bank</option>
                      <option value="Card">Card</option>
                    </select>
                  </td>
                  <td><input type="date" name="paymentDate" class="form-control"></td>
                  <td><input type="text" name="paymentNote" class="form-control"></td>
                  <td><button type="button" class="btn btn-sm btn-outline-danger remove-payment">Remove</button></td>
                </tr>
              </tbody>
            </table>
          </div>
          <button type="button" class="btn btn-outline-secondary" id="addPaymentBtn">Add Payment</button>
        </div>

        <button class="btn btn-primary">Save</button>
        <a href="/admin/projects" class="btn btn-secondary ms-2">Cancel</a>
      </form>
    </div>
  </div>

  <script>
    const serviceList = document.getElementById('serviceList');
    const addServiceBtn = document.getElementById('addServiceBtn');
    const serviceInput = document.getElementById('serviceInput');
    const liveDateInput = document.getElementById('liveDate');
    const dueDateInput = document.getElementById('dueDate');
    const paymentsTable = document.getElementById('paymentsTable').querySelector('tbody');
    const addPaymentBtn = document.getElementById('addPaymentBtn');
    const totalPaidDisplay = document.getElementById('totalPaidDisplay');

    const initialServices = <%- JSON.stringify(project && project.services ? (Array.isArray(project.services) ? project.services : [project.services]) : []) %>;

    function addServiceItem(name) {
      const item = document.createElement('div');
      item.className = 'form-check';
      item.innerHTML = `
        <input class="form-check-input" type="checkbox" name="services" value="${name}" checked>
        <label class="form-check-label">${name}</label>
      `;
      serviceList.appendChild(item);
    }

    initialServices.filter(Boolean).forEach(addServiceItem);

    addServiceBtn.addEventListener('click', () => {
      const value = serviceInput.value.trim();
      if (!value) return;
      addServiceItem(value);
      serviceInput.value = '';
    });

    function updateDueDate() {
      if (!liveDateInput.value) {
        dueDateInput.value = '';
        return;
      }
      const live = new Date(liveDateInput.value);
      const due = new Date(live);
      due.setFullYear(due.getFullYear() + 1);
      dueDateInput.value = due.toISOString().slice(0, 10);
    }

    liveDateInput.addEventListener('change', updateDueDate);
    updateDueDate();

    function updateTotalPaid() {
      const amounts = Array.from(document.querySelectorAll('.payment-amount'));
      const total = amounts.reduce((sum, input) => {
        const value = Number(input.value || 0);
        return sum + (Number.isNaN(value) ? 0 : value);
      }, 0);
      totalPaidDisplay.value = total.toFixed(2);
    }

    paymentsTable.addEventListener('input', (event) => {
      if (event.target.classList.contains('payment-amount')) {
        updateTotalPaid();
      }
    });

    paymentsTable.addEventListener('click', (event) => {
      if (!event.target.classList.contains('remove-payment')) return;
      const row = event.target.closest('tr');
      if (paymentsTable.children.length > 1) {
        row.remove();
        updateTotalPaid();
      }
    });

    addPaymentBtn.addEventListener('click', () => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="number" name="paymentAmount" class="form-control payment-amount" step="0.01"></td>
        <td>
          <select name="paymentMode" class="form-select">
            <option value="UPI">UPI</option>
            <option value="Cash">Cash</option>
            <option value="Bank">Bank</option>
            <option value="Card">Card</option>
          </select>
        </td>
        <td><input type="date" name="paymentDate" class="form-control"></td>
        <td><input type="text" name="paymentNote" class="form-control"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger remove-payment">Remove</button></td>
      `;
      paymentsTable.appendChild(row);
    });

    updateTotalPaid();
  </script>
</body>
</html>
