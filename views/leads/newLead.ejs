<!DOCTYPE html>
<html>
<head>
  <title><%= formTitle %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <%- include('../partials/sidebar') %>
  <div class="content">
    <%- include('../partials/header', { admin: admin }) %>
    <div class="container-fluid mt-4">
      <h3 class="mb-3"><%= formTitle %></h3>
      <% if (errors && errors.length > 0) { %>
        <% errors.forEach(function(err){ %>
          <div class="alert alert-danger"><%= err.msg %></div>
        <% }) %>
      <% } %>
      <% const assignedId = lead && lead.assignedTo ? (lead.assignedTo._id || lead.assignedTo) : ''; %>
      <% const servicesValue = lead && Array.isArray(lead.services) ? lead.services.join(', ') : (lead && lead.services ? lead.services : ''); %>
      <% const currentStatus = lead && lead.status ? lead.status : 'new'; %>
      <% const editAllowedValue = lead && typeof lead.editAllowed !== 'undefined' ? lead.editAllowed : true; %>
      <form action="<%= action %>" method="POST" class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Name</label>
          <input type="text" name="name" class="form-control" value="<%= lead ? lead.name : '' %>" required>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Contact</label>
          <input type="text" name="contact" class="form-control" value="<%= lead ? lead.contact : '' %>">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-control" value="<%= lead ? lead.email : '' %>">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="new" <%= currentStatus === 'new' ? 'selected' : '' %>>New</option>
            <option value="contacted" <%= currentStatus === 'contacted' ? 'selected' : '' %>>Contacted</option>
            <option value="in-progress" <%= currentStatus === 'in-progress' ? 'selected' : '' %>>In Progress</option>
            <option value="closed" <%= currentStatus === 'closed' ? 'selected' : '' %>>Closed</option>
          </select>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Assigned To</label>
          <select name="assignedTo" class="form-select">
            <option value="">Unassigned</option>
            <% if (workers && workers.length > 0) { %>
              <% workers.forEach(function(worker){ %>
                <option value="<%= worker._id %>" <%= String(assignedId) === String(worker._id) ? 'selected' : '' %>><%= worker.name || worker.email %></option>
              <% }) %>
            <% } %>
          </select>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Business Name</label>
          <input type="text" name="businessName" class="form-control" value="<%= lead ? lead.businessName : '' %>">
        </div>
        <div class="col-12">
          <label class="form-label">Services</label>
          <input type="text" name="services" class="form-control" value="<%= servicesValue %>" placeholder="Web design, SEO, Maintenance">
          <div class="form-text">Enter services as a comma-separated list.</div>
        </div>
        <div class="col-12">
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-control" rows="4"><%= lead ? lead.notes : '' %></textarea>
        </div>
        <div class="col-12 d-flex flex-column flex-sm-row gap-2">
          <button class="btn btn-primary">Save</button>
          <a href="/admin/leads" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
